{% extends 'base.html' %}

{% block title %}
    {% if is_create %}Neuen Kontakt erstellen{% else %}Kontakt bearbeiten{% endif %}
{% endblock %}

{% block page_title %}
    {% if is_create %}Neuen Kontakt erstellen{% else %}Kontakt bearbeiten{% endif %}
{% endblock %}

{% block content %}
    <div class="bg-white shadow-lg rounded-lg overflow-hidden border border-gray-100">
        <div class="p-6 md:p-8">
            <form id="contactForm" novalidate>
                {% csrf_token %}
                
                {# Nicht-Feld-Fehler (oben für bessere Sichtbarkeit) #}
                <div id="formErrors" class="mb-6 p-4 bg-red-50 text-red-700 rounded-md border border-red-200 text-sm hidden">
                    <p class="flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i><span id="errorMessage"></span></p>
                </div>

                {# Grid Layout für die Formularfelder #}
                <div class="grid grid-cols-1 gap-y-6 gap-x-8 md:grid-cols-2">
                    {# Vorname #}
                    <div>
                        <div class="mb-1">
                            <label for="first_name" class="block text-sm font-medium text-gray-700">
                                Vorname
                                <span class="text-red-500 font-semibold">*</span>
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="first_name" name="first_name" required
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="Vorname eingeben">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Nachname #}
                    <div>
                        <div class="mb-1">
                            <label for="last_name" class="block text-sm font-medium text-gray-700">
                                Nachname
                                <span class="text-red-500 font-semibold">*</span>
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="last_name" name="last_name" required
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="Nachname eingeben">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-user text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# E-Mail #}
                    <div>
                        <div class="mb-1">
                            <label for="email" class="block text-sm font-medium text-gray-700">
                                E-Mail
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="email" id="email" name="email"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="vorname.nachname@firma.de">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-envelope text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Telefon #}
                    <div>
                        <div class="mb-1">
                            <label for="phone_number" class="block text-sm font-medium text-gray-700">
                                Telefon
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="tel" id="phone_number" name="phone_number"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="+49 123 456789">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-phone text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Mobil #}
                    <div>
                        <div class="mb-1">
                            <label for="mobile_number" class="block text-sm font-medium text-gray-700">
                                Mobil
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="tel" id="mobile_number" name="mobile_number"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="+49 123 456789">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-mobile-alt text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Position #}
                    <div>
                        <div class="mb-1">
                            <label for="job_title" class="block text-sm font-medium text-gray-700">
                                Position
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="job_title" name="job_title"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="z.B. Geschäftsführer">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-briefcase text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Firma #}
                    <div>
                        <div class="mb-1">
                            <label for="account" class="block text-sm font-medium text-gray-700">
                                Firma
                            </label>
                            
                            <div class="mt-1">
                                <select id="account" name="account"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Firma auswählen</option>
                                    {% for account in accounts %}
                                        <option value="{{ account.id }}">{{ account.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <p class="mt-1 text-xs text-gray-500">Zu welcher Firma gehört dieser Kontakt?</p>
                        </div>
                    </div>

                    {# Zuständiges Team #}
                    <div>
                        <div class="mb-1">
                            <label for="assigned_group" class="block text-sm font-medium text-gray-700">
                                Zuständiges Team
                            </label>
                            
                            <div class="mt-1">
                                <select id="assigned_group" name="assigned_group"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Team auswählen</option>
                                    {% for group in request.user.groups.all %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    {# Adressfelder #}
                    <div class="md:col-span-2">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Adresse</h3>
                    </div>

                    {# Straße #}
                    <div>
                        <div class="mb-1">
                            <label for="street" class="block text-sm font-medium text-gray-700">
                                Straße
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="street" name="street"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="Musterstraße 123">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-map-marker-alt text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# PLZ #}
                    <div>
                        <div class="mb-1">
                            <label for="postal_code" class="block text-sm font-medium text-gray-700">
                                PLZ
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="postal_code" name="postal_code"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="12345">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-mail-bulk text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Stadt #}
                    <div>
                        <div class="mb-1">
                            <label for="city" class="block text-sm font-medium text-gray-700">
                                Stadt
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="city" name="city"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="Musterstadt">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-city text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Land #}
                    <div>
                        <div class="mb-1">
                            <label for="country" class="block text-sm font-medium text-gray-700">
                                Land
                            </label>
                            
                            <div class="mt-1 relative">
                                <div class="flex items-center">
                                    <div class="relative w-full">
                                        <input type="text" id="country" name="country"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm pl-10"
                                               placeholder="Deutschland">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <i class="fas fa-flag text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# Tagging-Felder #}
                <div class="grid grid-cols-1 gap-y-6 gap-x-8 md:grid-cols-2">
                    <div class="md:col-span-2">
                        <div class="mb-1">
                            <label for="tags" class="block text-sm font-medium text-gray-700">
                                Tags
                            </label>
                            
                            <div class="mt-1">
                                <input type="text" id="tags" name="tags" 
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                       placeholder="Tags eingeben (Enter oder Komma zum Trennen)"
                                       data-role="tagsinput" data-tag-type="general">
                            </div>
                            
                            <p class="mt-1 text-xs text-gray-500">Geben Sie Tags ein und drücken Sie Enter oder Komma. Neue Tags werden automatisch erstellt.</p>
                        </div>
                    </div>
                </div>

                {# Trennlinie und Buttons am Ende #}
                <div class="mt-8 pt-5 border-t border-gray-200">
                    <div class="flex justify-end space-x-4">
                        <a href="{% url 'customers:contact_list' %}" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-times mr-2"></i>Abbrechen
                        </a>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-save mr-2"></i>Speichern
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    $(function() {
        const isCreate = {{ is_create|yesno:"true,false" }};
        const contactId = '{{ contact_id|default:"" }}';
        
        // CSRF Token für AJAX Requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace('#','');
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? '#222' : '#fff';
        }

        function autocompleteTags(query, process) {
            $.get('/core/tag-autocomplete/', {q: query}, function(data) {
                process(data.results);
            });
        }

        async function createTag(tagName, tagType) {
            try {
                const response = await fetch('{% url "core:create_tag" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        name: tagName,
                        type: tagType
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    return data;
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }

        $('#tags').tagsinput({
            trimValue: true,
            confirmKeys: [13, 44],
            tagClass: function(item) {
                let color = item.color || '#10b981';
                let textColor = getContrastYIQ(color);
                return '';
            },
            itemValue: 'text',
            itemText: 'text',
            typeahead: {
                source: function(query) {
                    var result = [];
                    var process = function(items) { result = items; };
                    autocompleteTags(query, process);
                    return result;
                },
                afterSelect: function(item) {
                    $('#tags').tagsinput('add', item);
                },
                displayText: function(item) {
                    return item.text;
                },
                matcher: function(item, query) {
                    return item.text.toLowerCase().indexOf(query.toLowerCase()) !== -1;
                }
            },
            beforeTagAdd: async function(event) {
                if (typeof event.item === 'string') {
                    const newTag = await createTag(event.item, 'general');
                    if (newTag) {
                        event.item = {text: newTag.name, color: newTag.color};
                        event.cancel = false;
                    } else {
                        event.cancel = true;
                        alert('Fehler beim Erstellen des Tags: ' + event.item);
                    }
                }
            },
            tagFormatter: function(item) {
                let color = item.color || '#10b981';
                let textColor = getContrastYIQ(color);
                return `<span class=\"tag\" style=\"background:${color};color:${textColor};\">${item.text}</span>`;
            }
        });

        // Daten beim Bearbeiten laden
        if (!isCreate && contactId) {
            loadContactData();
        }

        async function loadContactData() {
            try {
                const response = await fetch(`/customers/api/contacts/${contactId}/data/`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        // Formularfelder befüllen
                        $('#first_name').val(data.data.first_name);
                        $('#last_name').val(data.data.last_name);
                        $('#email').val(data.data.email);
                        $('#phone_number').val(data.data.phone_number);
                        $('#mobile_number').val(data.data.mobile_number);
                        $('#job_title').val(data.data.job_title);
                        $('#street').val(data.data.street);
                        $('#postal_code').val(data.data.postal_code);
                        $('#city').val(data.data.city);
                        $('#country').val(data.data.country);
                        $('#account').val(data.data.account);
                        $('#assigned_group').val(data.data.assigned_group);
                        
                        // Tags laden
                        if (data.data.tags) {
                            data.data.tags.split(',').forEach(function(tag) {
                                if (tag.trim()) {
                                    $('#tags').tagsinput('add', {text: tag.trim()});
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden der Contact-Daten:', error);
            }
        }

        // Formular absenden
        $('#contactForm').on('submit', async function(e) {
            e.preventDefault();
            
            // Loading-Zustand
            const submitBtn = $(this).find('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html('<i class="fas fa-spinner fa-spin mr-2"></i>Speichere...');
            submitBtn.prop('disabled', true);
            
            // Fehler ausblenden
            $('#formErrors').addClass('hidden');
            
            try {
                // Formulardaten sammeln
                const formData = {
                    first_name: $('#first_name').val(),
                    last_name: $('#last_name').val(),
                    email: $('#email').val(),
                    phone_number: $('#phone_number').val(),
                    mobile_number: $('#mobile_number').val(),
                    job_title: $('#job_title').val(),
                    street: $('#street').val(),
                    postal_code: $('#postal_code').val(),
                    city: $('#city').val(),
                    country: $('#country').val(),
                    account: $('#account').val(),
                    assigned_group: $('#assigned_group').val(),
                    tags: $('#tags').tagsinput('items').map(item => item.text).join(', ')
                };
                
                // API-Endpunkt bestimmen
                const url = isCreate 
                    ? '{% url "customers:api_contact_create" %}'
                    : `/customers/api/contacts/${contactId}/update/`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Erfolg - Weiterleitung
                    window.location.href = result.redirect_url;
                } else {
                    // Fehler anzeigen
                    $('#errorMessage').text(result.message);
                    $('#formErrors').removeClass('hidden');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                $('#errorMessage').text('Ein unerwarteter Fehler ist aufgetreten.');
                $('#formErrors').removeClass('hidden');
            } finally {
                // Loading-Zustand zurücksetzen
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
            }
        });
    });
</script>
{% endblock %}
